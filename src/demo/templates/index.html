<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORGe - Voice Claim Intake Demo</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-900 mb-2">FORGe</h1>
            <p class="text-gray-600">AI-Powered Voice Claim Intake System</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Status Bar -->
            <div id="statusBar" class="bg-indigo-600 text-white px-6 py-3 flex items-center justify-between">
                <span id="statusText">Ready to start</span>
                <span id="frustrationMeter" class="hidden">üòä</span>
            </div>

            <!-- Call Controls -->
            <div class="p-8 text-center">
                <button id="startCallBtn" onclick="startCall()" 
                        class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full text-xl font-semibold shadow-lg transition transform hover:scale-105">
                    üìû Start Call
                </button>
                <button id="endCallBtn" onclick="endCall()" 
                        class="hidden bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full text-xl font-semibold shadow-lg transition transform hover:scale-105">
                    ‚ùå End Call
                </button>
                
                <!-- Listening Indicator -->
                <div id="listeningIndicator" class="hidden mt-6">
                    <div class="inline-block relative">
                        <div class="w-20 h-20 bg-red-500 rounded-full animate-pulse"></div>
                        <div class="absolute top-0 left-0 w-20 h-20 bg-red-500 rounded-full pulse-ring"></div>
                    </div>
                    <p class="mt-2 text-gray-600">Listening...</p>
                </div>
                
                <!-- Speaking Indicator -->
                <div id="speakingIndicator" class="hidden mt-6">
                    <div class="inline-block relative">
                        <div class="w-20 h-20 bg-blue-500 rounded-full animate-pulse"></div>
                    </div>
                    <p class="mt-2 text-gray-600">Assistant speaking...</p>
                </div>
            </div>

            <!-- Conversation -->
            <div class="px-8 pb-8">
                <div id="conversation" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto space-y-3">
                    <p class="text-center text-gray-400">Conversation will appear here...</p>
                </div>
            </div>

            <!-- Extracted Data -->
            <div class="px-8 pb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">üìã Extracted Claim Data</h3>
                <div id="claimData" class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 rounded p-3">
                        <span class="text-xs text-gray-500">Policy ID</span>
                        <p id="policyId" class="font-semibold text-gray-800">-</p>
                    </div>
                    <div class="bg-blue-50 rounded p-3">
                        <span class="text-xs text-gray-500">Customer Name</span>
                        <p id="customerName" class="font-semibold text-gray-800">-</p>
                    </div>
                    <div class="bg-blue-50 rounded p-3">
                        <span class="text-xs text-gray-500">Incident Type</span>
                        <p id="incidentType" class="font-semibold text-gray-800">-</p>
                    </div>
                    <div class="bg-blue-50 rounded p-3">
                        <span class="text-xs text-gray-500">Date</span>
                        <p id="incidentDate" class="font-semibold text-gray-800">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-gray-500 text-sm">
            Powered by OpenAI GPT-4 & ElevenLabs
        </div>
    </div>

    <script>
        const socket = io();
        let recognition = null;
        let isListening = false;
        let shouldListen = false;
        let collectedTranscript = '';
        let silenceTimer = null;

        // Initialize Web Speech API
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;  // Keep listening
            recognition.interimResults = true;  // Get partial results
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                // Clear silence timer
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }

                // Get the latest result
                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript;

                if (result.isFinal) {
                    // Final result - add to collected transcript
                    collectedTranscript += transcript + ' ';
                    console.log('Final:', transcript);
                    
                    // Set timer to send after 1.5 seconds of silence
                    silenceTimer = setTimeout(() => {
                        if (collectedTranscript.trim()) {
                            console.log('Sending full transcript:', collectedTranscript.trim());
                            socket.emit('user_speech', { text: collectedTranscript.trim() });
                            collectedTranscript = '';
                            stopListening();
                        }
                    }, 1500);
                } else {
                    // Interim result - just log it
                    console.log('Interim:', transcript);
                }
            };

            recognition.onend = () => {
                console.log('Recognition ended');
                isListening = false;
                document.getElementById('listeningIndicator').classList.add('hidden');
                
                // If we should still be listening and have nothing pending, restart
                if (shouldListen && !collectedTranscript.trim()) {
                    setTimeout(() => {
                        if (shouldListen) startListening();
                    }, 100);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                
                // Ignore no-speech errors, just restart
                if (event.error === 'no-speech' && shouldListen) {
                    setTimeout(() => {
                        if (shouldListen) startListening();
                    }, 100);
                }
            };
        } else {
            alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
        }

        function startListening() {
            if (recognition && !isListening && shouldListen) {
                try {
                    collectedTranscript = '';
                    recognition.start();
                    isListening = true;
                    document.getElementById('listeningIndicator').classList.remove('hidden');
                    document.getElementById('speakingIndicator').classList.add('hidden');
                    console.log('Started listening');
                } catch (e) {
                    console.error('Error starting recognition:', e);
                    isListening = false;
                }
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                    isListening = false;
                    document.getElementById('listeningIndicator').classList.add('hidden');
                    console.log('Stopped listening');
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
            }
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        }

        function startCall() {
            socket.emit('start_call');
            shouldListen = true;
            document.getElementById('startCallBtn').classList.add('hidden');
            document.getElementById('endCallBtn').classList.remove('hidden');
            document.getElementById('statusText').textContent = 'Call in progress...';
        }

        function endCall() {
            socket.emit('end_call');
            shouldListen = false;
            stopListening();
            collectedTranscript = '';
            document.getElementById('startCallBtn').classList.remove('hidden');
            document.getElementById('endCallBtn').classList.add('hidden');
            document.getElementById('listeningIndicator').classList.add('hidden');
            document.getElementById('speakingIndicator').classList.add('hidden');
            document.getElementById('statusText').textContent = 'Call ended';
        }

        // Socket event handlers
        socket.on('assistant_message', (data) => {
            addMessage('assistant', data.text);
            updateFrustration(data.frustration);
            
            // Show speaking indicator, hide listening
            document.getElementById('speakingIndicator').classList.remove('hidden');
            document.getElementById('listeningIndicator').classList.add('hidden');
            
            // Stop listening while assistant speaks
            stopListening();
        });

        socket.on('user_message', (data) => {
            addMessage('user', data.text);
        });

        socket.on('ready_to_listen', () => {
            console.log('Server says: ready to listen');
            // Hide speaking indicator
            document.getElementById('speakingIndicator').classList.add('hidden');
            
            // Start listening immediately (no delay!)
            if (shouldListen) {
                startListening();
            }
        });

        socket.on('claim_update', (data) => {
            updateClaimData(data.data);
        });

        socket.on('call_complete', (data) => {
            document.getElementById('statusText').textContent = '‚úÖ Claim Complete!';
            document.getElementById('statusBar').classList.remove('bg-indigo-600');
            document.getElementById('statusBar').classList.add('bg-green-600');
        });

        socket.on('call_ended', (data) => {
            addMessage('system', `Call ended: ${data.message}`);
            endCall();
        });

        socket.on('error', (data) => {
            addMessage('system', `Error: ${data.message}`);
        });

        function addMessage(sender, text) {
            const conversation = document.getElementById('conversation');
            
            // Remove placeholder if exists
            const placeholder = conversation.querySelector('.text-center.text-gray-400');
            if (placeholder) placeholder.remove();
            
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'bg-blue-100 rounded-lg p-3 ml-auto max-w-md';
                messageDiv.innerHTML = `<p class="text-sm text-gray-700"><strong>You:</strong> ${text}</p>`;
            } else if (sender === 'assistant') {
                messageDiv.className = 'bg-white rounded-lg p-3 mr-auto max-w-md border border-gray-200';
                messageDiv.innerHTML = `<p class="text-sm text-gray-700"><strong>Assistant:</strong> ${text}</p>`;
            } else {
                messageDiv.className = 'text-center text-gray-500 text-sm italic';
                messageDiv.innerHTML = `<p>${text}</p>`;
            }
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function updateClaimData(data) {
            document.getElementById('policyId').textContent = data.policyId || '-';
            document.getElementById('customerName').textContent = data.customerName || '-';
            document.getElementById('incidentType').textContent = data.incidentType || '-';
            document.getElementById('incidentDate').textContent = data.incidentDate || '-';
        }

        function updateFrustration(score) {
            const meter = document.getElementById('frustrationMeter');
            if (score > 0) {
                meter.classList.remove('hidden');
                if (score < 3) meter.textContent = 'üòä';
                else if (score < 6) meter.textContent = 'üòê';
                else meter.textContent = 'üò§';
            }
        }
    </script>
</body>
</html>